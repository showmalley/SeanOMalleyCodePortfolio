---
title: "Understand AT&T Campaign"
author: "Principia Analytics"
output:
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

############ Ingest & Initiate

require(dplyr)
require(ggplot2)
require(lubridate)
require(beeswarm)
require(smooth)
require(zoo)

setwd('/Users/SeanOMalley1/AnacondaProjects/AdHocDataScience/ATT/')
df_tp <- read.csv('att_tp.csv')

df_tp$EVENT_DATE <- ymd_hms(df_tp$EVENT_DATE)

head(df_tp)

glimpse(df_tp)

df_t <- df_tp %>%
            mutate(P_COUNT = 1) %>%
            group_by(EVENT_DATE) %>%
            summarise(P_COUNT = sum(P_COUNT),
                      SPEND = sum(SPEND),
                      REVENUE = sum(REVENUE))

df_t$PROFIT <- df_t$REVENUE - df_t$SPEND

```

#### Explore Summary Data Through Time

Using 2018 data, we can see that there was an exlosion of placements used, of which initially looks to have just ate into  profit. Note that even revenue takes a dip after the expansion of placements, while spend stays consistent. Which implies that we spend down on what worked to spend up on exploring.

```{r, echo = FALSE}

par(mfrow=c(2,2))

ggplot(df_t, aes(x = EVENT_DATE, y = P_COUNT)) +
  geom_line(color = '#FF6347') +
  ggtitle('Count Of Active Lines') +
  theme_grey()

ggplot(df_t, aes(x = EVENT_DATE, y = SPEND)) +
  geom_line(color = 'darkred') +
  geom_smooth(method = 'lm', color = 'darkgray') + 
  ggtitle('Spend') +
  theme_grey()

ggplot(df_t, aes(x = EVENT_DATE, y = REVENUE)) +
  geom_line(color = 'darkgreen') +
  geom_smooth(method = 'lm', color = 'darkgray') + 
  ggtitle('Revenue') +
  theme_grey()

ggplot(df_t, aes(x = EVENT_DATE, y = PROFIT)) +
  geom_line(color = 'darkblue') +
  geom_smooth(method = 'lm', color = 'darkgray') + 
  ggtitle('PROFIT') +
  theme_grey()

```

The notion that the more lines, the worse the profit given the same spend is proven by the strong negative correlation between the number of placements and the profit produced. 

```{r, echo = FALSE}

# moving average

cor(rollmean(df_t$P_COUNT, 21), rollmean(df_t$PROFIT, 21))

```


```{r, include = FALSE}

############ Placement

head(df_tp)

glimpse(df_tp)

dfp <- df_tp %>%
          select(PLACEMENT_NAME, SPEND, REVENUE) %>%
          group_by(PLACEMENT_NAME)  %>%
          summarise(SPEND = sum(SPEND), 
                    REVENUE = sum(REVENUE)) %>%
          mutate(PROFIT = REVENUE - SPEND)

dfp$PROFIT <- dfp$REVENUE - dfp$SPEND
dfp$PROFIT_M <- dfp$PROFIT

for (i in 1:length(dfp$PROFIT)){
  if(dfp$PROFIT[i] == 0){
    dfp$PROFIT_M[i] <-  'black'
  } else if(dfp$PROFIT[i] < 0){
    dfp$PROFIT_M[i] <-  'red'
  } else {
    dfp$PROFIT_M[i] <-  'green'
  }
}

```

This brings my to an intial conclusion that we need to isolate the placements that bring us profit, as well as their allocated buget in order to ensure that we spend what we can on those placments completely separate from our exploration budget. 

We can actually view how poorly most the placements perform in this beeswarm plot:

```{r, echo = FALSE}

beeswarm(dfp$PROFIT,
         pch = 16, pwcol = dfp$PROFIT_M,
         cex= 1.5,
         xlab = "", ylab = "Profit",
         labels = "Placement",
         priority = 'density',
         method = 'center',
         corral = 'wrap',
         main = "Profit by Placement")
legend("topright", legend = c("Push", "Loss", "Gain"),
       title = "Lines", pch = 16, col = 1:3)

```

These are making money:

```{r, echo = FALSE}

green <- dfp %>% filter(PROFIT_M == 'green') %>% select(PLACEMENT_NAME)
print(green)

```

These placements are losing money:

```{r, echo = FALSE}

red <- dfp %>% filter(PROFIT_M == 'red') %>% select(PLACEMENT_NAME)
print(red)

```

These placements are a push:

```{r, echo = FALSE}

black <- dfp %>% filter(PROFIT_M == 'black') %>% select(PLACEMENT_NAME)
print(black)

```

Proportion of placements actually making money

```{r, echo = FALSE}

prof_prop <- round((length(green) / (length(green)+length(red)+length(black)))*100,2)
cat(prof_prop, "%")

```


